/********************************************************************
//DM430-L???????1602??????ADC?????????????????ADC?????????????????????????§³
//MSP430????????12¦ËADC?????????2.5V????????????????????§Ø??????§à??????
//???????????????????????ADC0???????P60?????????????????????????4095??2.5V
//?????????EW430 V5.30
//?????www.avrgcc.com
//???2014.03.01
********************************************************************/

#include <msp430x14x.h>
#include "Config.h"                     //???????????????????????IO??????
#include "1602.c"

static uchar Flag=0;                    //???????
uint TEMP=0;                            //ADC??????? 
uint    temp,A1,A2,A3,A4,A5,A6,A7;      //????????,??????????

//***********************************************************************
//      ??????????ADC???
//***********************************************************************
void LCD_DisplayADC()
{    
  LCD_write_char(0x0b,0,0x30+A1);
  LCD_write_char(0x0c,0,0x30+A2);
  LCD_write_char(0x0d,0,0x30+A3);
  LCD_write_char(0x0e,0,0X30+A4);
}

void LCD_DisplayVoltage()
{    
  LCD_write_char(0x0b,1,0x30+A5);
  LCD_write_char(0x0c,1,'.');
  LCD_write_char(0x0d,1,0x30+A6);
  LCD_write_char(0x0e,1,0X30+A7);
  LCD_write_char(0x0f,1,'V');
}
//*************************************************************************
//		?????????????????
//*************************************************************************
void Data_do(uint temp_d)
{
  uint temp_1,temp_2;
  A1=temp_d/1000;                       //???????????????¦Ë
  temp_1=temp_d%1000;
  A2=temp_1/100;
  temp_2=temp_1%100;
  A3=temp_2/10;
  A4=temp_2%10;
}

//*************************************************************************
//		??????????????????
//*************************************************************************
void Voltage_do(uint temp_d)
{
  uint temp_1,temp_2;
  ulong temp_3;
  
  temp_3=(ulong)(temp_d)*250;            //????????ADC???????????????§³?????????????
  temp_d=temp_3/4095;                    //12¦Ë?????????4095
  
  A5=temp_d/100;                        //????????????¦Ë
  temp_1=temp_d%100;
  A6=temp_1/10;
  temp_2=temp_1%10;
  A7=temp_2;
}

//*************************************************************************
//	ADC?????????????????ADC???????
//*************************************************************************
void ADC_Init()
{
  P6SEL|=0x01;                                    //???ADC???
  ADC12CTL0|= ADC12ON + SHT0_2 + REF2_5V + REFON; //ADC??????????16??CLK????????2.5V
  ADC12CTL1|= ADC12SSEL1 + ADC12SSEL0;            //SMCLK??????
  ADC12MCTL0= SREF0 + INCH_0;                     //?¦Ï?????¦Ë??????????????????0
  ADC12IE|= 0x01;                                 //?§Ø?????
  ADC12CTL0|= ENC;                                //????????
}

//*************************************************************************
//	ADC?§Ø???????
//*************************************************************************
#pragma vector=ADC_VECTOR
__interrupt void ADC12ISR(void)
{
  uchar j;
  while((ADC12CTL1&0x01)==1);           //???ADC???????????????ADC??????
  Flag = 1 ;
  TEMP = ADC12MEM0;                     //???ADC????
  Data_do(TEMP);                        //????ADC??????????????????
  Voltage_do(TEMP);                     //????ADC??????????????????
  for(j=0;j<15;j++)
  {
    LCD_DisplayADC();                   //???ADC???????ADC??????
    LCD_DisplayVoltage();               //???ADC?????
  }
}

//***********************************************************************
//            ??????
//***********************************************************************
void main(void)
{ 
  WDT_Init();                         //??????????
  Clock_Init();                       //???????
  Port_Init();                        //????????????????IO??????????
  ADC_Init();                         //?????ADC????
  delay_ms(100);                      //???100ms
  LCD_init();                         //????????????????
  LCD_clear();                        //????
  LCD_Desk();
  _EINT();                            //????§Ø?
  Flag=1;                             //???¦Ë????1
  
  while(1)
  {
    while(Flag==1)
    {
      ADC12CTL0 |= ADC12SC;           //???????
      ADC12CTL0 &= ~ADC12SC;          //????
      Flag=0;                         //??????¦Ë
    }
  }
}